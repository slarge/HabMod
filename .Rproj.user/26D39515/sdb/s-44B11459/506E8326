{
    "collab_server" : "",
    "contents" : "#-------------------------------------------------------------------------------\n#Requiredpackages\nlibrary(randomForest)\nlibrary(miscTools)\nlibrary(raster)\nlibrary(automap)\n\nrequire(maps)\nlibrary(marmap)\n\n#-------------------------------------------------------------------------------\n#setwd(\"C:/1_habitat_analysis_2017/spring models fits lt\")\nsetwd(\"C:/1_habitat_analysis_2017/spring models fits st\")\n#-------------------------------------------------------------------------------\n# a grid circumscriobe the ne shelf \nnes.grid = read.csv(\"nes_lon_lat.csv\", header=T)\n# make copy of nes.grid\nnes.grid.pred = nes.grid\n# make both spatial data frames\ncoordinates(nes.grid.pred) <- ~x+y\n#-------------------------------------------------------------------------------\n# get bathy data\ngetNOAA.bathy(lon1 = -77, lon2 = -65, lat1 = 35, lat2 = 45,\n              resolution = 10) -> nesbath\n#-------------------------------------------------------------------------------\n#often used in code that follows\nxy=with(nes.grid,cbind(x,y))\n#-------------------------------------------------------------------------------\n# get models to predict habitat\nfiles = list.files(pattern=\".rdata\")\n#-------------------------------------------------------------------------------\nrast_dir = \"C:/1_habitat_analysis_2017/static_vars/\"\nzoo_dir = \"C:/1_analyses_ne_shelf/nes zoo/ecomon 3_1/maps/spring_raster/\"\n\nsst_r = \"C:/1_habitat_analysis_2017/sst/NESREG/\"\nsst_r_clim = \"C:/1_habitat_analysis_2017/sst/NESREG/clim/\"\nsst_f = \"C:/1_habitat_analysis_2017/sst/NESREG/fronts/\"\nsst_f_clim = \"C:/1_habitat_analysis_2017/sst/NESREG/fronts/clim/\"\n\nchl_r = \"C:/1_habitat_analysis_2017/chl/NESREG/\"\nchl_r_clim = \"C:/1_habitat_analysis_2017/chl/NESREG/clim/\"\nchl_f = \"C:/1_habitat_analysis_2017/chl/NESREG/fronts/\"\nchl_f_clim = \"C:/1_habitat_analysis_2017/chl/NESREG/fronts/clim/\"\n\nST_SD_dir = \"C:/1_habitat_analysis_2017/surftemp/spring_spdf/rasters/\"\nBT_SD_dir = \"C:/1_habitat_analysis_2017/bottemp/spring_spdf/rasters/\"\nBOTSALIN_dir=\"C:/1_habitat_analysis_2017/botsal/spring_spdf/rasters/\"\nSURFSALIN_dir=\"C:/1_habitat_analysis_2017/surfsal/spring_spdf/rasters/\"\n#-------------------------------------------------------------------------------\n\n#------------------------------------------------- get source locations raster\nload(\"C:/1_habitat_analysis_2017/particle transport/for_proj_5day_source_x.rdata\")\n# remane \nfive_day_x = masked.raster\nload(\"C:/1_habitat_analysis_2017/particle transport/for_proj_5day_source_y.rdata\")\n# remane \nfive_day_y = masked.raster\n\nsl_x = extract(five_day_x,xy,method=\"bilinear\") \nsl_y = extract(five_day_y,xy,method=\"bilinear\") \nsxy = cbind(sl_x,sl_y)\n#------------------------------------------------- get source loations raster\n# loop for models\nfor(j in 1:length(files)){\n  \n  # load random forest model not the AP model\n  load(gsub(\"ap_\",\"\",files[j]))\n\n  # create dir for any rasters\n  dir.create(file.path(getwd(), gsub(\"ap_\",\"\",gsub(\".rdata\",\"\",files[j]))), showWarnings = FALSE)\n\n# get variables for the model\nim = importance(run.rf)\nim = data.frame(im)\npred.vars = row.names(im)\n#-------------------------------------------------------------------------------\n\nif(unlist(strsplit(files[j],\"_\"))[3]=='lts'){\n  start_year=1992\n}\n\nif(unlist(strsplit(files[j],\"_\"))[3]=='sts'){\n  start_year=2000\n}\n\n  \n# loop for years\nfor (year in start_year:2016){\n    \n# create dataframe to hold a year of data at a time, start with blank data\npred.data = data.frame(array(data=NA, dim=c(nrow(nes.grid),length(pred.vars)+2)))\ncolnames(pred.data) <- c(\"x\",\"y\",pred.vars)\n\n# reload the x and y each time\npred.data$x = nes.grid$x\npred.data$y = nes.grid$y\n\n#-------------------------------------------------------------------------------\n# special case get DEPTH\nif(\"DEPTH\" %in% pred.vars) {\n  load(\"C:/1_habitat_analysis_2017/static_vars/rast_gdepth.rdata\")\n  pred.data$DEPTH = extract(masked.raster,xy,method=\"bilinear\")  \n}\n\n#-------------------------------------------------------------------------------\n# get the rast data used\nfor (i in 1:length(pred.vars)){\n  test = pmatch(\"rast\",pred.vars[i],nomatch=0)\n  if(test == 1){\n    fname= paste(rast_dir,pred.vars[4],\".rdata\", sep=\"\")\n    load(fname)\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n} # end get rast\n\n#-------------------------------------------------------------------------------\n# get the zoo clim data used\nfor (i in 1:length(pred.vars)){\n  test = pmatch(\"zoo_spr_clim\",pred.vars[i],nomatch=0)\n  if(test == 1){\n    load(paste(zoo_dir,gsub(\"zoo_spr_clim_\",\"\",pred.vars[i]), \"_all_yr.rdata\",sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n} # end get zoo clim\n\n#-------------------------------------------------------------------------------\n# get the sst r clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"sst_r_clim\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"sst_r_clim_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"2000.\",mo,sep=\"\")\n    file = list.files(path=sst_r_clim,pattern=pat)\n    load(paste(sst_r_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"2000.\",mo,sep=\"\")\n    file = list.files(path=sst_r_clim,pattern=pat)\n    load(paste(sst_r_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get sst clim\n\n# get the sst f clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"sst_f_clim\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"sst_f_clim_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"2000.\",mo,sep=\"\")\n    file = list.files(path=sst_f_clim,pattern=pat)\n    load(paste(sst_f_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"2000.\",mo,sep=\"\")\n    file = list.files(path=sst_f_clim,pattern=pat)\n    load(paste(sst_f_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get sst clim\n\n#-------------------------------------------------------------------------------\n# get the chl r clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"chl_r_clim\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"chl_r_clim_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"1998.\",mo,sep=\"\")\n    file = list.files(path=chl_r_clim,pattern=pat)\n    load(paste(chl_r_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"1998.\",mo,sep=\"\")\n    file = list.files(path=chl_r_clim,pattern=pat)\n    load(paste(chl_r_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get chl clim\n\n# get the chl f clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"chl_f_clim\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"chl_f_clim_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"1998.\",mo,sep=\"\")\n    file = list.files(path=chl_f_clim,pattern=pat)\n    load(paste(chl_f_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(\"1998.\",mo,sep=\"\")\n    file = list.files(path=chl_f_clim,pattern=pat)\n    load(paste(chl_f_clim,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get chl clim\n\n#-------------------------------------------------------------------------------\n#    END STATIC VARS\n# not used\n#BOTTEMP\n#SURFTEMP\n#-------------------------------------------------------------------------------\n\n#-------------------------------------------------------------------------------\n# special case get BT_SD\nif(\"BT_SD\" %in% pred.vars) {\n  pat = paste(\"_\",year,sep=\"\")\n  file = list.files(path=BT_SD_dir,pattern=pat)\n  load(paste(BT_SD_dir,file,sep=\"\"))\n  pred.data$BT_SD = extract(masked.raster,xy,method=\"bilinear\")  \n}\n\n# special case get ST_SD\nif(\"ST_SD\" %in% pred.vars) {\n  pat = paste(\"_\",year,sep=\"\")\n  file = list.files(path=ST_SD_dir,pattern=pat)\n  load(paste(ST_SD_dir,file,sep=\"\"))\n  pred.data$ST_SD = extract(masked.raster,xy,method=\"bilinear\")  \n}\n\n# special case get BOTSALIN\nif(\"BOTSALIN\" %in% pred.vars) {\n  pat = paste(\"_\",year,sep=\"\")\n  file = list.files(path=BOTSALIN_dir,pattern=pat)\n  load(paste(BOTSALIN_dir,file,sep=\"\"))\n  pred.data$BOTSALIN = extract(masked.raster,xy,method=\"bilinear\")  \n}\n\n# special case get BOTSALIN\nif(\"SURFSALIN\" %in% pred.vars) {\n  pat = paste(\"_\",year,sep=\"\")\n  file = list.files(path=SURFSALIN_dir,pattern=pat)\n  load(paste(SURFSALIN_dir,file,sep=\"\"))\n  pred.data$SURFSALIN = extract(masked.raster,xy,method=\"bilinear\")  \n}\n\n#-------------------------------------------------------------------------------\n# get the zoo ann data used\nfor (i in 1:length(pred.vars)){\n  test = pmatch(\"zoo_spr_ann\",pred.vars[i],nomatch=0)\n  if(test == 1){\n    pat = paste(\"_\",year,sep=\"\")\n    file = list.files(path=paste(zoo_dir , gsub(\"zoo_spr_ann_\",\"\",pred.vars[i]),\"/\",sep=\"\"),pattern=pat)\n    load(paste(zoo_dir , gsub(\"zoo_spr_ann_\",\"\",pred.vars[i]),\"/\",file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n} # end get zoo ann\n\n#-------------------------------------------------------------------------------\n\n\n\n\n\n\n\n# get the sst r clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"sst_r_ann\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"sst_r_ann_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=sst_r,pattern=pat)\n    load(paste(sst_r,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=sst_r,pattern=pat)\n    load(paste(sst_r,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get sst clim\n\n# get the sst f clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"sst_f_ann\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"sst_f_ann_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=sst_f,pattern=pat)\n    load(paste(sst_f,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=sst_f,pattern=pat)\n    load(paste(sst_f,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get sst clim\n\n#-------------------------------------------------------------------------------\n# get the chl r clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"chl_r_ann\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"chl_r_ann_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=chl_r,pattern=pat)\n    load(paste(chl_r,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=chl_r,pattern=pat)\n    load(paste(chl_r,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get chl clim\n\n# get the chl f clim data used\nfor (i in 1:length(pred.vars)){\n  test1 = pmatch(\"chl_f_ann\",pred.vars[i],nomatch=0)\n  test2 = pmatch(\"chl_f_ann_s\",pred.vars[i],nomatch=0)\n  test = test1+test2\n  if(test == 1){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=chl_f,pattern=pat)\n    load(paste(chl_f,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,xy,method=\"bilinear\")  \n  }\n  if(test == 2){\n    mo = substr(pred.vars[i], nchar(pred.vars[i])-1, nchar(pred.vars[i]))\n    pat = paste(year,\".\",mo,sep=\"\")\n    file = list.files(path=chl_f,pattern=pat)\n    load(paste(chl_f,file,sep=\"\"))\n    pred.data[,i+2] = extract(masked.raster,sxy,method=\"bilinear\")  \n  }\n} # end get chl clim\n\n# remove incomplete cases\npred.data <- pred.data[complete.cases(pred.data), ]\n\n# predict habitat values based in rf model\nrun.rf.pr = predict(run.rf,pred.data[,3:ncol(pred.data)])\n\n# over write pred.data since not use again\ncont.out = data.frame(cbind(pred.data$x,pred.data$y,run.rf.pr))\n\n# make spdf for kriging\ncoordinates(cont.out) <- ~V1+V2\n\n# Ordinary kriging to make complete depth grid\nkriging_result = autoKrige(run.rf.pr~1, cont.out, nes.grid.pred)\n\n# get krig output\nk_out = kriging_result$krige_output\n\n# make project and save raster\nmasked.raster = rasterFromXYZ(k_out) \ncrs(masked.raster) <- \"+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0\" \noutfile = paste(\"RAST_NESREG_\",year,\".04.03.BT.TEMP.YEAR.000066596.RData\",sep=\"\")\noutfile = paste(file.path(getwd(), gsub(\".rdata\",\"\",files[j])),\"/\",outfile,sep=\"\")\noutfile=gsub(\"ap_\",\"\",outfile)\nsave(masked.raster,file=outfile)\n\n# make pdf\noutfile = paste(gsub(\".rdata\",\"\",files[j]),\"_\",year,\".pdf\",sep=\"\")\noutfile = paste(file.path(getwd(), gsub(\".rdata\",\"\",files[j])),\"/\",outfile,sep=\"\")\noutfile=gsub(\"ap_\",\"\",outfile)\npdf (file= outfile)\nplot(masked.raster)\nmap(\"state\",add=T)\nplot(nesbath,deep=-200, shallow=-200, step=1,add=T,lwd=1,col=\"gray50\",lty=2)\ndev.off()\n\n\n\n} # end year loop\n\n}  # sp model loop\n\n",
    "created" : 1503645431782.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3235502120",
    "id" : "506E8326",
    "lastKnownWriteTime" : 1499682999,
    "last_content_update" : 1499682999,
    "path" : "C:/Users/scott.large/Google Drive/temp_for_scott/1_habitat_analysis_2017/spring models fits lt/form pred data for hab models.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 9,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}